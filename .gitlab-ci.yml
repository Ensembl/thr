image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/python:3.11

variables:
  # Share pip downloads across jobs to reduce install time.
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

stages:
  - pylint
  - test
  - build

cache:
  paths:
    - .cache/pip

pylint:
  stage: pylint
  script:
    - python -V
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pylint $(git ls-files '*.py') --django-settings-module=thr.settings --fail-under=9

pytest:
  stage: test
  variables:
    # Keep ES host explicit for code paths reading settings from env.
    ES_HOST: "elasticsearch:9200"
    ELASTICSEARCH_URL: "http://elasticsearch:9200"
    # Lower heap for CI runners; enough for test startup.
    ES_JAVA_OPTS: "-Xms512m -Xmx512m"
  services:
    # Pin to the currently used Elasticsearch major/minor.
    - name: docker.elastic.co/elasticsearch/elasticsearch:7.17.5
      alias: elasticsearch
      # Single-node + no security keeps CI service lightweight and accessible.
      command: [ "bin/elasticsearch", "-Ediscovery.type=single-node", "-Expack.security.enabled=false", "-Ehttp.host=0.0.0.0" ]
  script:
    - python -V
    - pip install --upgrade pip
    - pip install -r requirements.txt
    # Tests run with thr.settings.test (sqlite + mocked ES in conftest)
    - pytest -vv

build:
  image: docker
  stage: build
  needs:
    - pytest
  services:
    - docker:dind
  variables:
    # Required for docker:dind compatibility on shared runners.
    DOCKER_API_VERSION: "1.43"
    DOCKER_TLS_CERTDIR: ""
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  before_script:
    - echo $CI_REGISTRY_TOKEN | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
  script:
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
